<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bisnis Interaktif</title>
    <!-- Load libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .health-score {
            position: relative;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .health-score-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
        }
        
        .table-row-hover:hover {
            background-color: #f1f5f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            min-height: 250px;
        }
        
        .anomaly-highlight {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .optimized-chart {
            will-change: transform;
            contain: strict;
        }
        
        .glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        
        .tooltip-custom {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-custom .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip-custom:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="gradient-bg text-white py-6 px-4 shadow-lg">
            <div class="container mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold flex items-center">
                            <i class="fas fa-chart-line mr-3"></i> 
                            REKAP DATA BISNIS MINGGUAN
                        </h1>
                        <p class="text-blue-100 mt-1">Analisis performa bisnis 1-7 Januari 2024</p>
                    </div>
                    <div class="flex items-center mt-4 md:mt-0 space-x-3">
                        <button id="toggleAnomalyBtn" class="bg-white text-blue-800 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium flex items-center transition-all glow smooth-transition">
                            <i class="fas fa-eye-slash mr-2"></i>
                            Sembunyikan Data Anomali
                        </button>
                        <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center smooth-transition">
                            <i class="fas fa-file-export mr-2"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifikasi dan Status Pembaruan -->
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div id="updateNotification" class="hidden bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg">
                Data telah diperbarui!
            </div>
            <div class="text-sm text-gray-500">
                <span id="lastUpdated">Terakhir diperbarui: Belum ada pembaruan</span> | 
                <span id="updateStatus" class="font-medium">Status: Menunggu</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-blue-500 smooth-transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Revenue</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalRevenue">Rp52,312,000</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fas fa-wallet text-blue-600 text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 flex items-center">
                        <span class="text-green-500 text-sm font-medium flex items-center">
                            <i class="fas fa-arrow-up mr-1"></i> 13988%
                        </span>
                        <span class="text-gray-400 text-sm ml-2">vs minggu lalu</span>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-green-500 smooth-transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Transaksi</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalTransactions">920</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg">
                            <i class="fas fa-shopping-cart text-green-600 text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 flex items-center">
                        <span class="text-red-500 text-sm font-medium flex items-center">
                            <i class="fas fa-arrow-down mr-1"></i> 5%
                        </span>
                        <span class="text-gray-400 text-sm ml-2">vs minggu lalu</span>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-purple-500 smooth-transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Rata-rata Revenue</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="avgRevenue">Rp7,473,143</h3>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg">
                            <i class="fas fa-chart-pie text-purple-600 text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Min: <span id="minRevenue">Rp275,000</span></span>
                            <span>Max: <span id="maxRevenue">Rp50,012,000</span></span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-yellow-500 smooth-transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Health Score</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="avgHealthScore">56</h3>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <i class="fas fa-heartbeat text-yellow-600 text-lg"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="health-score bg-gray-200">
                            <div class="health-score-bar bg-gradient-to-r from-yellow-400 to-yellow-600" style="width: 56%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Skor rata-rata minggu ini</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover smooth-transition">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-line-chart mr-2 text-blue-500"></i> Trend Revenue & Transaksi
                        </h2>
                        <div class="flex space-x-2">
                            <button class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">Mingguan</button>
                            <button class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Bulanan</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart" class="optimized-chart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 card-hover smooth-transition">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-bar-chart mr-2 text-green-500"></i> Perbandingan Revenue Harian
                        </h2>
                        <div class="text-sm text-gray-500 tooltip-custom">
                            <i class="fas fa-info-circle mr-1"></i> Termasuk prediksi hari ke-8
                            <span class="tooltiptext">Prediksi berdasarkan tren revenue minggu ini</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="barChart" class="optimized-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Daily Data Table -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8 smooth-transition">
                <div class="px-6 py-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center mb-2 md:mb-0">
                        <i class="fas fa-calendar-day mr-2 text-purple-500"></i> Detail Harian
                    </h2>
                    <div class="flex space-x-3 w-full md:w-auto">
                        <div class="relative w-full md:w-auto">
                            <select id="statusFilter" class="appearance-none bg-gray-100 border-0 text-gray-700 py-2 px-3 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                                <option value="all">Semua Status</option>
                                <option value="Hijau">Hijau</option>
                                <option value="Hitam">Hitam</option>
                                <option value="Merah">Merah</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-500 text-xs"></i>
                        </div>
                        <button id="resetFilterBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-sm whitespace-nowrap">
                            Reset Filter
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaksi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Health Score</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Insight</th>
                            </tr>
                        </thead>
                        <tbody id="dailyTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-3 border-t border-gray-100 flex justify-between items-center text-sm text-gray-500">
                    <div>
                        Menampilkan <span id="showingCount">7</span> dari <span id="totalCount">7</span> data
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPageBtn" class="px-3 py-1 rounded bg-gray-100 text-gray-600 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3 py-1">1</span>
                        <button id="nextPageBtn" class="px-3 py-1 rounded bg-gray-100 text-gray-600 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Weekly Insights -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 smooth-transition">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i> Weekly Insights
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="weeklyInsights">
                    <!-- Insights will be inserted here by JavaScript -->
                </div>
            </div>
            
            <!-- Performance Summary -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 smooth-transition">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-star mr-2 text-purple-500"></i> Performance Summary
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-md font-medium text-gray-700 mb-2">Best Day</h3>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="bg-blue-100 p-3 rounded-lg mr-3">
                                    <i class="fas fa-trophy text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-blue-800" id="bestDayDate">7 Januari 2024</h4>
                                    <p class="text-sm text-blue-700 mt-1">
                                        Revenue: <span id="bestDayRevenue">Rp50,012,000</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-md font-medium text-gray-700 mb-2">Worst Day</h3>
                        <div class="bg-red-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="bg-red-100 p-3 rounded-lg mr-3">
                                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-red-800" id="worstDayDate">3 Januari 2024</h4>
                                    <p class="text-sm text-red-700 mt-1">
                                        Revenue: <span id="worstDayRevenue">Rp275,000</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gray-50 py-6 border-t border-gray-200">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="text-gray-500 text-sm mb-4 md:mb-0">
                        ¬© 2024 Business Dashboard. All rights reserved.
                    </div>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-500 hover:text-blue-600">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" class="text-gray-500 hover:text-blue-400">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="text-gray-500 hover:text-red-500">
                            <i class="fab fa-instagram"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk mengambil data dari Google Spreadsheet
        async function fetchDataFromSpreadsheet() {
            const spreadsheetUrl = "https://docs.google.com/spreadsheets/d/12lMzDGZ0f3ZNCRuGxPjCU4d51nAj9T8t2qkkrgnYUik/pub?output=csv";

            try {
                const response = await fetch(spreadsheetUrl);
                const csvText = await response.text();

                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (result) => resolve(result.data),
                        error: (error) => reject(error)
                    });
                });
            } catch (error) {
                console.error("Gagal mengambil data dari Google Spreadsheet:", error);
                throw error;
            }
        }

        // Fungsi untuk mem-parse HTML dan mengkonversi ke format items
        function parseHtmlToItems(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');

            const dailyItems = Array.from(doc.querySelectorAll('ul li')).map(li => {
                const text = li.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]+>/g, '');
                const lines = text.split('\n').map(line => line.trim());

                const dateMatch = lines[0].match(/üìÜ (\d{4}-\d{2}-\d{2})/);
                const revenueMatch = lines[1].match(/üíµ Revenue: Rp([\d.]+)/);
                const revenueChangeMatch = lines[2].match(/üìà Perubahan Revenue: ([\d-]+%|Tidak ada data)/);
                const transaksiMatch = lines[3].match(/üßæ Transaksi: (\d+)/);
                const transaksiChangeMatch = lines[4].match(/üìâ Perubahan Transaksi: ([\d-]+%|Tidak ada data)/);
                const healthScoreMatch = lines[5].match(/üìä Health Score: (\d+)/);
                const statusMatch = lines[5].match(/D\d+ - [A-Za-z]+ \([A-Za-z]+\)/);
                const notesMatch = lines[6].match(/üìù Catatan: (.+)/);
                const insightMatch = lines[7].match(/üîç Insight: (.+)/);

                return {
                    date: dateMatch ? dateMatch[1] : "N/A",
                    revenue: revenueMatch ? parseInt(revenueMatch[1].replace(/\./g, '')) : 0,
                    transaksi: transaksiMatch ? parseInt(transaksiMatch[1]) : 0,
                    revenue_change: revenueChangeMatch ? (revenueChangeMatch[1] === "Tidak ada data" ? 0 : parseInt(revenueChangeMatch[1])) : 0,
                    transaksi_change: transaksiChangeMatch ? (transaksiChangeMatch[1] === "Tidak ada data" ? 0 : parseInt(transaksiChangeMatch[1])) : 0,
                    health_score: healthScoreMatch ? parseInt(healthScoreMatch[1]) : 0,
                    status: statusMatch ? statusMatch[0].split(' - ')[1].split(' (')[0] : "Tidak ada status",
                    notes: notesMatch ? notesMatch[1] : "Tidak ada catatan",
                    insight: insightMatch ? insightMatch[1] : "Tidak ada insight"
                };
            });

            const weeklyData = {};
            const weeklyParagraphs = Array.from(doc.querySelectorAll('p')).map(p => p.innerHTML.replace(/<[^>]+>/g, ''));
            weeklyParagraphs.forEach(paragraph => {
                if (paragraph.includes('Total Revenue')) {
                    const match = paragraph.match(/üí∞ Total Revenue: Rp([\d.]+)/);
                    weeklyData.sum_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Total Transaksi')) {
                    const match = paragraph.match(/üßæ Total Transaksi: (\d+)/);
                    weeklyData.sum_transaksi = match ? parseInt(match[1]) : 0;
                }
                if (paragraph.includes('Rata-rata Revenue')) {
                    const match = paragraph.match(/üìà Rata-rata Revenue: Rp([\d.]+)/);
                    weeklyData.average_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Rata-rata Transaksi')) {
                    const match = paragraph.match(/üìä Rata-rata Transaksi: ([\d.]+)/);
                    weeklyData.average_transaksi = match ? parseFloat(match[1]) : 0;
                }
                if (paragraph.includes('Max Revenue')) {
                    const match = paragraph.match(/üîº Max Revenue: Rp([\d.]+)/);
                    weeklyData.max_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Min Revenue')) {
                    const match = paragraph.match(/üîΩ Min Revenue: Rp([\d.]+)/);
                    weeklyData.min_revenue = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Prediksi Revenue')) {
                    const match = paragraph.match(/üßÆ Prediksi Revenue Hari Ke-8: Rp([\d.]+)/);
                    weeklyData.predicted_revenue_day_8 = match ? parseInt(match[1].replace(/\./g, '')) : 0;
                }
                if (paragraph.includes('Trend Revenue')) {
                    const match = paragraph.match(/üìâ Trend Revenue: (.+)/);
                    weeklyData.revenue_trend = match ? match[1] : "Stabil";
                }
                if (paragraph.includes('Trend Transaksi')) {
                    const match = paragraph.match(/üìâ Trend Transaksi: (.+)/);
                    weeklyData.transaction_trend = match ? match[1] : "Stabil";
                }
            });

            const insights = dailyItems.map(item => ({
                insight: item.insight,
                date: item.date,
                predicted_revenue_day_8: null,
                revenue_trend: "Stabil",
                transaction_trend: "Stabil",
                daily_health_scores: [],
                average_revenue: 0,
                average_transaksi: 0,
                max_revenue: 0,
                max_transaksi: 0,
                min_revenue: 0,
                min_transaksi: 0,
                sum_revenue: 0,
                sum_transaksi: 0
            }));

            const dailyHealthScores = dailyItems.map(item => ({
                date: item.date,
                revenue: item.revenue,
                transaksi: item.transaksi,
                revenue_change: item.revenue_change,
                transaksi_change: item.transaksi_change,
                health_score: item.health_score,
                status: item.status,
                notes: item.notes
            }));

            const weeklyItem = {
                insight: "Tidak ada insight",
                date: null,
                predicted_revenue_day_8: weeklyData.predicted_revenue_day_8 || 0,
                revenue_trend: weeklyData.revenue_trend || "Stabil",
                transaction_trend: weeklyData.transaction_trend || "Stabil",
                daily_health_scores: dailyHealthScores,
                average_revenue: weeklyData.average_revenue || 0,
                average_transaksi: weeklyData.average_transaksi || 0,
                max_revenue: weeklyData.max_revenue || 0,
                max_transaksi: 0,
                min_revenue: weeklyData.min_revenue || 0,
                min_transaksi: 0,
                sum_revenue: weeklyData.sum_revenue || 0,
                sum_transaksi: weeklyData.sum_transaksi || 0
            };

            return [...insights, weeklyItem];
        }

        // State global untuk menyimpan data
        let dailyData = [];
        let weeklyData = {};
        let showAnomaly = true;
        let currentFilter = "all";
        let filteredDailyData = [];
        let lastHtmlString = ""; // Untuk membandingkan data lama dan baru
        let revenueChart, barChart;

        // Fungsi untuk format waktu pembaruan
        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        // Fungsi untuk mendapatkan warna status
        function getStatusColor(status) {
            switch(status) {
                case "Hijau": return "bg-green-100 text-green-800";
                case "Hitam": return "bg-black text-white";
                case "Merah": return "bg-red-100 text-red-800";
                default: return "bg-gray-100 text-gray-800";
            }
        }

        // Fungsi untuk mendapatkan warna perubahan
        function getChangeColor(change) {
            return change >= 0 ? "text-green-500" : "text-red-500";
        }

        // Fungsi untuk format tanggal
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleString('id-ID', { month: 'long' });
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        // Fungsi untuk memperbarui data dan UI
        async function updateDataAndUI() {
            try {
                const csvData = await fetchDataFromSpreadsheet();
                const htmlString = csvData[1]["HTML Report"] || ""; // Kolom B2

                // Bandingkan dengan data lama
                if (htmlString === lastHtmlString) {
                    console.log("Data belum berubah, lewati pembaruan UI");
                    document.getElementById("lastUpdated").textContent = `Terakhir diperbarui: ${formatTimestamp()}`;
                    document.getElementById("updateStatus").textContent = "Status: Sukses (Data tidak berubah)";
                    document.getElementById("updateStatus").classList.remove("text-red-500");
                    document.getElementById("updateStatus").classList.add("text-green-500");
                    return;
                }

                lastHtmlString = htmlString; // Simpan data baru
                const items = parseHtmlToItems(htmlString);

                const healthDataItem = items.find(item => item.daily_health_scores && item.daily_health_scores.length > 0);
                const dailyHealthScores = healthDataItem ? healthDataItem.daily_health_scores : [];
                const insights = items.filter(item => item.insight && item.date).map(item => ({ date: item.date, insight: item.insight }));

                dailyData = dailyHealthScores.map(day => {
                    const insightObj = insights.find(i => i.date === day.date);
                    return {
                        date: day.date || "N/A",
                        revenue: day.revenue || 0,
                        transaksi: day.transaksi || 0,
                        revenue_change: day.revenue_change || 0,
                        transaksi_change: day.transaksi_change || 0,
                        health_score: day.health_score || 0,
                        status: day.status || "Tidak ada status",
                        notes: day.notes || "Tidak ada catatan",
                        insight: insightObj ? insightObj.insight : "Tidak ada insight"
                    };
                });

                weeklyData = {
                    predicted_revenue_day_8: healthDataItem ? healthDataItem.predicted_revenue_day_8 || 0 : 0,
                    revenue_trend: healthDataItem ? healthDataItem.revenue_trend || "Tidak ada tren" : "Tidak ada tren",
                    transaction_trend: healthDataItem ? healthDataItem.transaction_trend || "Tidak ada tren" : "Tidak ada tren",
                    average_revenue: dailyData.length > 0 ? dailyData.reduce((sum, day) => sum + day.revenue, 0) / dailyData.length : 0,
                    average_transaksi: dailyData.length > 0 ? dailyData.reduce((sum, day) => sum + day.transaksi, 0) / dailyData.length : 0,
                    max_revenue: dailyData.length > 0 ? Math.max(...dailyData.map(day => day.revenue)) : 0,
                    min_revenue: dailyData.length > 0 ? Math.min(...dailyData.filter(day => day.revenue !== undefined).map(day => day.revenue)) : 0,
                    sum_revenue: dailyData.reduce((sum, day) => sum + day.revenue, 0),
                    sum_transaksi: dailyData.reduce((sum, day) => sum + day.transaksi, 0)
                };

                applyFilters();

                // Tampilkan notifikasi dan update status
                const notification = document.getElementById("updateNotification");
                notification.classList.remove("hidden");
                setTimeout(() => {
                    notification.classList.add("hidden");
                }, 3000); // Sembunyikan setelah 3 detik

                document.getElementById("lastUpdated").textContent = `Terakhir diperbarui: ${formatTimestamp()}`;
                document.getElementById("updateStatus").textContent = "Status: Sukses";
                document.getElementById("updateStatus").classList.remove("text-red-500");
                document.getElementById("updateStatus").classList.add("text-green-500");
            } catch (error) {
                document.getElementById("lastUpdated").textContent = `Terakhir diperbarui: ${formatTimestamp()}`;
                document.getElementById("updateStatus").textContent = "Status: Gagal";
                document.getElementById("updateStatus").classList.remove("text-green-500");
                document.getElementById("updateStatus").classList.add("text-red-500");
                console.error("Pembaruan data gagal:", error);
            }
        }

        // Fungsi untuk toggle data anomali
        function toggleAnomaly() {
            showAnomaly = !showAnomaly;
            applyFilters();
            
            const btn = document.getElementById("toggleAnomalyBtn");
            if (showAnomaly) {
                btn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i> Sembunyikan Data Anomali';
                btn.classList.remove("bg-red-100", "text-red-800");
                btn.classList.add("bg-white", "text-blue-800", "glow");
            } else {
                btn.innerHTML = '<i class="fas fa-eye mr-2"></i> Tampilkan Data Anomali';
                btn.classList.remove("bg-white", "text-blue-800", "glow");
                btn.classList.add("bg-red-100", "text-red-800");
            }
        }

        // Fungsi untuk apply semua filter
        function applyFilters() {
            // Filter anomali
            let tempData = showAnomaly ? [...dailyData] : dailyData.filter(d => d.date !== "2024-01-07");
            
            // Filter status
            if (currentFilter !== "all") {
                tempData = tempData.filter(d => d.status === currentFilter);
            }
            
            filteredDailyData = tempData;
            
            updateTable();
            updateCharts();
            updateSummaryCards();
            updateWeeklyInsights();
            updatePerformanceSummary();
            updateCountDisplay();
        }

        // Update tabel
        function updateTable() {
            const tableBody = document.getElementById("dailyTableBody");
            tableBody.innerHTML = "";
            
            filteredDailyData.forEach(d => {
                const row = document.createElement("tr");
                row.className = `table-row-hover ${d.date === "2024-01-07" ? "anomaly-highlight" : ""}`;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${formatDate(d.date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="font-medium">Rp${d.revenue.toLocaleString("id-ID")}</div>
                        <div class="${getChangeColor(d.revenue_change)} text-xs">
                            ${d.revenue_change >= 0 ? '<i class="fas fa-arrow-up mr-1"></i>' : '<i class="fas fa-arrow-down mr-1"></i>'}
                            ${Math.abs(d.revenue_change)}%
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="font-medium">${d.transaksi}</div>
                        <div class="${getChangeColor(d.transaksi_change)} text-xs">
                            ${d.transaksi_change >= 0 ? '<i class="fas fa-arrow-up mr-1"></i>' : '<i class="fas fa-arrow-down mr-1"></i>'}
                            ${Math.abs(d.transaksi_change)}%
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900 mr-2">${d.health_score}</div>
                            <div class="health-score bg-gray-200 w-16">
                                <div class="health-score-bar ${d.health_score >= 75 ? 'bg-green-500' : d.health_score >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${d.health_score}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusColor(d.status)}">${d.status}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs">
                        ${d.notes.includes("‚ö†Ô∏è") ? '<span class="text-red-500 mr-1"><i class="fas fa-exclamation-triangle"></i></span>' : ''}
                        ${d.notes.includes("üìà") ? '<span class="text-green-500 mr-1"><i class="fas fa-chart-line"></i></span>' : ''}
                        ${d.notes.replace(/‚ö†Ô∏è|üìà/g, '')}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                            ${d.insight}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Update kartu ringkasan
        function updateSummaryCards() {
            const filteredWeeklyData = {
                predicted_revenue_day_8: weeklyData.predicted_revenue_day_8,
                revenue_trend: weeklyData.revenue_trend,
                transaction_trend: weeklyData.transaction_trend,
                average_revenue: filteredDailyData.length > 0 ? filteredDailyData.reduce((sum, day) => sum + day.revenue, 0) / filteredDailyData.length : 0,
                average_transaksi: filteredDailyData.length > 0 ? filteredDailyData.reduce((sum, day) => sum + day.transaksi, 0) / filteredDailyData.length : 0,
                max_revenue: filteredDailyData.length > 0 ? Math.max(...filteredDailyData.map(day => day.revenue)) : 0,
                min_revenue: filteredDailyData.length > 0 ? Math.min(...filteredDailyData.filter(day => day.revenue !== undefined).map(day => day.revenue)) : 0,
                sum_revenue: filteredDailyData.reduce((sum, day) => sum + day.revenue, 0),
                sum_transaksi: filteredDailyData.reduce((sum, day) => sum + day.transaksi, 0)
            };

            document.getElementById("totalRevenue").textContent = `Rp${filteredWeeklyData.sum_revenue.toLocaleString("id-ID")}`;
            document.getElementById("totalTransactions").textContent = filteredWeeklyData.sum_transaksi;
            document.getElementById("avgRevenue").textContent = `Rp${filteredWeeklyData.average_revenue.toLocaleString("id-ID")}`;
            document.getElementById("minRevenue").textContent = `Rp${filteredWeeklyData.min_revenue.toLocaleString("id-ID")}`;
            document.getElementById("maxRevenue").textContent = `Rp${filteredWeeklyData.max_revenue.toLocaleString("id-ID")}`;
            
            // Update health score bar
            const avgHealthScore = filteredDailyData.length > 0 ? 
                filteredDailyData.reduce((sum, day) => sum + day.health_score, 0) / filteredDailyData.length : 0;
            document.getElementById("avgHealthScore").textContent = Math.round(avgHealthScore);
            document.querySelector(".health-score-bar").style.width = `${avgHealthScore}%`;
        }

        // Update weekly insights
        function updateWeeklyInsights() {
            const insightsContainer = document.getElementById("weeklyInsights");
            insightsContainer.innerHTML = "";
            
            const filteredInsights = showAnomaly ? insights : insights.filter(i => i.date !== "2024-01-07");
            
            filteredInsights.forEach(insight => {
                const insightCard = document.createElement("div");
                insightCard.className = "bg-gray-50 rounded-lg p-4 border border-gray-200 smooth-transition hover:bg-gray-100";
                
                const date = new Date(insight.date);
                const dayName = date.toLocaleDateString('id-ID', { weekday: 'long' });
                const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
                
                insightCard.innerHTML = `
                    <div class="flex items-start">
                        <div class="bg-blue-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-calendar-day text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800">${dayName}, ${formattedDate}</h4>
                            <p class="text-sm text-gray-600 mt-1">${insight.insight}</p>
                        </div>
                    </div>
                `;
                
                insightsContainer.appendChild(insightCard);
            });
            
            // Add prediction card
            const predictionCard = document.createElement("div");
            predictionCard.className = "bg-blue-50 rounded-lg p-4 border border-blue-200 smooth-transition hover:bg-blue-100";
            predictionCard.innerHTML = `
                <div class="flex items-start">
                    <div class="bg-blue-200 p-2 rounded-lg mr-3">
                        <i class="fas fa-chart-line text-blue-700"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-blue-800">Prediksi Hari Ke-8</h4>
                        <p class="text-sm text-blue-700 mt-1">
                            Revenue diprediksi mencapai Rp${weeklyData.predicted_revenue_day_8.toLocaleString("id-ID")}
                        </p>
                        <div class="mt-2 text-xs text-blue-600">
                            <i class="fas fa-info-circle mr-1"></i> Berdasarkan tren ${weeklyData.revenue_trend.toLowerCase()}
                        </div>
                    </div>
                </div>
            `;
            insightsContainer.appendChild(predictionCard);
        }

        // Update performance summary
        function updatePerformanceSummary() {
            if (filteredDailyData.length === 0) return;
            
            // Find best and worst days
            const bestDay = filteredDailyData.reduce((max, day) => max.revenue > day.revenue ? max : day);
            const worstDay = filteredDailyData.reduce((min, day) => min.revenue < day.revenue ? min : day);
            
            document.getElementById("bestDayDate").textContent = formatDate(bestDay.date);
            document.getElementById("bestDayRevenue").textContent = `Rp${bestDay.revenue.toLocaleString("id-ID")}`;
            document.getElementById("worstDayDate").textContent = formatDate(worstDay.date);
            document.getElementById("worstDayRevenue").textContent = `Rp${worstDay.revenue.toLocaleString("id-ID")}`;
        }

        // Update count display
        function updateCountDisplay() {
            document.getElementById("showingCount").textContent = filteredDailyData.length;
            document.getElementById("totalCount").textContent = dailyData.length;
        }

        // Inisialisasi grafik
        function initCharts() {
            const revenueChartCtx = document.getElementById("revenueChart").getContext("2d");
            const barChartCtx = document.getElementById("barChart").getContext("2d");

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 12,
                            family: "'Poppins', sans-serif"
                        },
                        bodyFont: {
                            size: 12,
                            family: "'Poppins', sans-serif"
                        },
                        padding: 10,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 1) {
                                    label += context.raw / 100000;
                                } else {
                                    label += 'Rp' + context.raw.toLocaleString("id-ID");
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                family: "'Poppins', sans-serif",
                                size: 10
                            },
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return 'Rp' + (value / 1000000).toLocaleString("id-ID") + 'M';
                                }
                                return 'Rp' + value.toLocaleString("id-ID");
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: "'Poppins', sans-serif",
                                size: 10
                            }
                        }
                    }
                }
            };

            revenueChart = new Chart(revenueChartCtx, {
                type: "line",
                data: {
                    labels: filteredDailyData.map(d => formatDate(d.date).split(' ')[0] + ' ' + formatDate(d.date).split(' ')[1]),
                    datasets: [
                        {
                            label: "Revenue (Rp)",
                            data: filteredDailyData.map(d => d.revenue),
                            borderColor: "#3b82f6",
                            backgroundColor: "rgba(59, 130, 246, 0.1)",
                            borderWidth: 2,
                            pointBackgroundColor: filteredDailyData.map(d => 
                                d.date === "2024-01-07" ? "#ef4444" : "#3b82f6"
                            ),
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: "Transaksi (Scaled)",
                            data: filteredDailyData.map(d => d.transaksi * 100000),
                            borderColor: "#10b981",
                            backgroundColor: "rgba(16, 185, 129, 0.1)",
                            borderWidth: 2,
                            pointBackgroundColor: "#10b981",
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    ...commonChartOptions,
                    plugins: {
                        ...commonChartOptions.plugins,
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Poppins', sans-serif",
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            barChart = new Chart(barChartCtx, {
                type: "bar",
                data: {
                    labels: [...filteredDailyData.map(d => formatDate(d.date).split(' ')[0] + ' ' + formatDate(d.date).split(' ')[1]), "Prediksi"],
                    datasets: [{
                        label: "Revenue (Rp)",
                        data: [...filteredDailyData.map(d => d.revenue), weeklyData.predicted_revenue_day_8],
                        backgroundColor: [
                            ...filteredDailyData.map(d => 
                                d.date === "2024-01-07" ? "#ef4444" : "#3b82f6"
                            ),
                            "#9333ea" // Purple for prediction
                        ],
                        borderRadius: 4,
                        borderWidth: 0
                    }]
                },
                options: commonChartOptions
            });
        }

        // Update grafik
        function updateCharts() {
            revenueChart.data.labels = filteredDailyData.map(d => formatDate(d.date).split(' ')[0] + ' ' + formatDate(d.date).split(' ')[1]);
            revenueChart.data.datasets[0].data = filteredDailyData.map(d => d.revenue);
            revenueChart.data.datasets[1].data = filteredDailyData.map(d => d.transaksi * 100000);
            
            // Update colors for anomaly
            revenueChart.data.datasets[0].pointBackgroundColor = filteredDailyData.map(d => 
                d.date === "2024-01-07" ? "#ef4444" : "#3b82f6"
            );
            
            revenueChart.update();

            barChart.data.labels = [...filteredDailyData.map(d => formatDate(d.date).split(' ')[0] + ' ' + formatDate(d.date).split(' ')[1]), "Prediksi"];
            barChart.data.datasets[0].data = [...filteredDailyData.map(d => d.revenue), weeklyData.predicted_revenue_day_8];
            
            // Update colors for bars
            barChart.data.datasets[0].backgroundColor = [
                ...filteredDailyData.map(d => 
                    d.date === "2024-01-07" ? "#ef4444" : "#3b82f6"
                ),
                "#9333ea" // Purple for prediction
            ];
            
            barChart.update();
        }

        // Export function
        function exportData() {
            // In a real app, this would export to CSV/PDF
            alert("Fitur export akan mengunduh data dalam format CSV");
        }

        // Inisialisasi dan polling
        document.addEventListener("DOMContentLoaded", async function() {
            // Inisialisasi pertama kali
            await updateDataAndUI();
            
            // Inisialisasi grafik setelah data dimuat
            setTimeout(() => {
                initCharts();
            }, 100);
            
            // Polling setiap 5 menit
            setInterval(async () => {
                await updateDataAndUI();
            }, 300000); // 300000 ms = 5 menit

            // Add event listeners
            document.getElementById("toggleAnomalyBtn").addEventListener("click", toggleAnomaly);
            document.getElementById("exportBtn").addEventListener("click", exportData);
            document.getElementById("statusFilter").addEventListener("change", function() {
                currentFilter = this.value;
                applyFilters();
            });
            document.getElementById("resetFilterBtn").addEventListener("click", function() {
                document.getElementById("statusFilter").value = "all";
                currentFilter = "all";
                applyFilters();
            });
        });
    </script>
</body>
</html>
